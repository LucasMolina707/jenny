<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta para ti</title>
    
    <!-- Open Graph Tags para compartir en WhatsApp y otras redes sociales -->
    <meta property="og:title" content="¬°Una carta para ti!"/>
    <meta property="og:description" content="Abre este mensaje especial para descubrir una sorpresa."/>
    <meta property="og:image" content="https://j.inglucas.com.co/galeri/corazon.gif"/>
    <meta property="og:url" content="URL_DE_TU_PAGINA"/>
    <meta property="og:type" content="website"/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-size: 200% 200%;
            transition: background-image 2s ease-in-out, background-color 2s ease-in-out;
            min-height: 100vh;
        }

        input[type="radio"] {
            display: none;
        }

        #step1-content, #step2-content, #step3-content {
            display: none;
        }

        #step1:checked ~ .container #step1-content {
            display: flex;
        }

        #step2:checked ~ .container #step2-content {
            display: flex;
        }

        #step3:checked ~ .container #step3-content {
            display: flex;
            animation: pop-in 1s ease-out forwards;
        }
        
        @keyframes pop-in {
            0% {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .day-sky {
            background-image: linear-gradient(135deg, #87CEEB, #B0E0E6, #FFD700);
            animation: move-day-bg 20s ease-in-out infinite alternate;
        }

        @keyframes move-day-bg {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .night-sky {
            background-image: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            animation: twinkle 50s ease-in-out infinite alternate, move-night-bg 120s linear infinite;
        }
        .night-sky::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent url(https://www.transparenttextures.com/patterns/stardust.png) repeat;
            animation: move-stars 120s linear infinite;
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        @keyframes move-stars {
            from { background-position: 0 0; }
            to { background-position: 1000px 500px; }
        }
    </style>
</head>
<body class="h-screen flex justify-center items-center">
    <!-- Radio buttons para controlar el flujo -->
    <input type="radio" name="gift-steps" id="step1" checked>
    <input type="radio" name="gift-steps" id="step2">
    <input type="radio" name="gift-steps" id="step3">

    <div class="container flex justify-center items-center h-full w-full">
        <div class="content flex flex-col items-center justify-center space-y-8">

            <!-- Etapa 1: Mensaje inicial y bot√≥n -->
            <div id="step1-content" class="flex-col items-center justify-center space-y-8">
                <div id="greeting-message" class="text-3xl font-semibold text-gray-800">
                    Oye mira...
                </div>
                <div class="text-9xl animate-pulse transition-all duration-300">
                    üéÅ
                </div>
                <label for="step2" class="px-8 py-3 bg-rose-500 text-white font-bold text-xl rounded-full shadow-lg cursor-pointer transition-all duration-300 hover:bg-rose-600 hover:scale-105 mt-8">
                    Continuar
                </label>
            </div>

            <!-- Etapa 2: Mensaje de la carta y bot√≥n para abrir -->
            <div id="step2-content" class="flex-col items-center justify-center space-y-8">
                <div class="text-3xl font-semibold text-gray-800">
                    Ha llegado esto para ti
                </div>
                <!-- Al hacer clic en la carta, se activa el paso 3 -->
                <label for="step3" class="text-9xl cursor-pointer transition-all duration-300 hover:scale-110">
                    üíå
                </label>
                <div class="text-xl font-medium text-gray-700">
                    Pulsa en la carta para abrir
                </div>
            </div>

            <!-- Etapa 3: Carta final con el mensaje -->
            <div id="step3-content" class="bg-purple-100 border-4 border-purple-800 p-8 rounded-2xl shadow-xl max-w-sm text-center flex-col items-center space-y-4">
                <span id="final-message-text" class="text-4xl font-semibold text-gray-900 leading-tight">
                    Cuidate‚ú®
                    <br>
                    o si no
                    <br>
                    con quien
                    <br>
                    me voy a
                    <br>
                    casar
                    <br>
                    <span class="text-5xl">üêß‚ù§Ô∏èüêß</span>
                </span>
                <button id="listen-btn" class="px-8 py-3 bg-indigo-500 text-white font-bold text-xl rounded-full shadow-lg cursor-pointer transition-all duration-300 hover:bg-indigo-600 hover:scale-105 mt-4">
                    Escuchar el mensaje ‚ú®
                </button>
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n para cambiar el fondo y el saludo seg√∫n la hora del d√≠a
        function setDailyMood() {
            const body = document.body;
            const greetingElement = document.getElementById('greeting-message');
            const hour = new Date().getHours();

            // Asignar el fondo y el saludo de d√≠a o noche
            if (hour >= 6 && hour < 19) {
                // De 6 a.m. a 7 p.m.
                body.classList.remove('night-sky');
                body.classList.add('day-sky');
                greetingElement.textContent = '¬°Hola, buenos d√≠as!';
            } else {
                // De 7 p.m. a 6 a.m.
                body.classList.remove('day-sky');
                body.classList.add('night-sky');
                greetingElement.textContent = '¬°Hola, buenas noches!';
            }
        }

        // Llamar a la funci√≥n al cargar la p√°gina
        setDailyMood();

        // Funci√≥n para manejar la s√≠ntesis de voz (sin cambios)
        async function playAudio(textToSpeak) {
            const listenBtn = document.getElementById('listen-btn');
            const originalText = listenBtn.textContent;
            listenBtn.textContent = 'Generando audio...';
            listenBtn.disabled = true;

            const payload = {
                contents: [{ parts: [{ text: `Di con un tono tierno y divertido: ${textToSpeak}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Autonoe" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                let audioContext = new (window.AudioContext || window.webkitAudioContext)();
                let backoffTime = 1000;
                let response = null;

                while (true) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status !== 429) {
                            break;
                        }
                        console.warn(`API rate limit exceeded. Retrying in ${backoffTime}ms.`);
                        await new Promise(resolve => setTimeout(resolve, backoffTime));
                        backoffTime *= 2;

                    } catch (error) {
                        console.error('Fetch error:', error);
                        break;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const base64ToArrayBuffer = (base64) => {
                        const binaryString = window.atob(base64);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        return bytes.buffer;
                    };

                    const pcmToWav = (pcmData, sampleRate) => {
                        const pcm16 = new Int16Array(pcmData);
                        const buffer = new ArrayBuffer(44 + pcm16.length * 2);
                        const view = new DataView(buffer);
                        
                        const writeString = (view, offset, string) => {
                            for (let i = 0; i < string.length; i++) {
                                view.setUint8(offset + i, string.charCodeAt(i));
                            }
                        };
                        
                        let offset = 0;
                        writeString(view, offset, 'RIFF'); offset += 4;
                        view.setUint32(offset, 36 + pcm16.length * 2, true); offset += 4;
                        writeString(view, offset, 'WAVE'); offset += 4;
                        writeString(view, offset, 'fmt '); offset += 4;
                        view.setUint32(offset, 16, true); offset += 4;
                        view.setUint16(offset, 1, true); offset += 2;
                        view.setUint16(offset, 1, true); offset += 2; // Mono
                        view.setUint32(offset, sampleRate, true); offset += 4;
                        view.setUint32(offset, sampleRate * 2, true); offset += 4;
                        view.setUint16(offset, 2, true); offset += 2;
                        view.setUint16(offset, 16, true); offset += 2; // 16-bit
                        writeString(view, offset, 'data'); offset += 4;
                        view.setUint32(offset, pcm16.length * 2, true); offset += 4;
                        
                        for (let i = 0; i < pcm16.length; i++, offset += 2) {
                            view.setInt16(offset, pcm16[i], true);
                        }
                        return new Blob([view], { type: 'audio/wav' });
                    };

                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    listenBtn.textContent = '¬°Mensaje escuchado!';
                } else {
                    throw new Error('Invalid audio data received');
                }
            } catch (error) {
                console.error('Error in TTS process:', error);
                listenBtn.textContent = 'Error al generar audio';
            } finally {
                listenBtn.disabled = false;
                setTimeout(() => {
                    listenBtn.textContent = originalText;
                }, 3000);
            }
        }

        const finalMessageText = document.getElementById('final-message-text').innerText;
        document.getElementById('listen-btn').addEventListener('click', () => {
            playAudio(finalMessageText);
        });
    </script>
</body>
</html>
